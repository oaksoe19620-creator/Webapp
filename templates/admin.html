<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Telegram Shop</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>⚙️ Admin Panel</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-link">Back to Shop</a>
            </nav>
        </header>

        <div class="admin-tabs">
            <button class="tab-btn active" data-tab="products">Products</button>
            <button class="tab-btn" data-tab="orders">Orders</button>
        </div>

        <!-- Products Management -->
        <div class="tab-content active" id="products-tab">
            <div class="section-header">
                <h2>Product Management</h2>
                <button class="btn btn-primary" id="addProductBtn">Add New Product</button>
            </div>

            <div class="products-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td>
                                <img src="{{ product.image_url }}" alt="{{ product.name }}" class="table-image">
                            </td>
                            <td>{{ product.name }}</td>
                            <td>${{ "%.2f"|format(product.price) }}</td>
                            <td>{{ product.category }}</td>
                            <td>
                                <span class="status {{ 'active' if product.active else 'inactive' }}">
                                    {{ 'Active' if product.active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary edit-product" data-id="{{ product.id }}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-product" data-id="{{ product.id }}">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Management -->
        <div class="tab-content" id="orders-tab">
            <div class="section-header">
                <h2>Order Management</h2>
            </div>

            <div class="orders-table">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Payment Method</th>
                            <th>Payment Proof</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>
                                <div>
                                    <strong>@{{ order.username }}</strong><br>
                                    <small>{{ order.first_name }} {{ order.last_name }}</small>
                                </div>
                            </td>
                            <td>${{ "%.2f"|format(order.total) }}</td>
                            <td>{{ order.payment_method }}</td>
                            <td>
                                {% if order.payment_proof %}
                                <button class="btn btn-sm btn-info view-payment-proof" 
                                        data-proof="{{ url_for('static', filename='uploads/' + order.payment_proof) }}"
                                        data-order="{{ order.id }}">
                                    View Proof
                                </button>
                                {% else %}
                                <span class="text-muted">No proof</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status {{ order.status }}">{{ order.status.title() }}</span>
                            </td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-order" data-id="{{ order.id }}">View Details</button>
                                {% if order.status == 'pending' %}
                                <button class="btn btn-sm btn-success confirm-order" data-id="{{ order.id }}">Confirm</button>
                                <button class="btn btn-sm btn-danger decline-order" data-id="{{ order.id }}">Decline</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Add New Product</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price:</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category:</label>
                    <input type="text" id="productCategory" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Description:</label>
                    <textarea id="productDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImage">Image URL:</label>
                    <input type="url" id="productImage">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Product</button>
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Order Details</h2>
            <div id="orderDetails">
                <!-- Order details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Payment Proof Modal -->
    <div class="modal" id="paymentProofModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Payment Proof - Order #<span id="proofOrderId"></span></h2>
            <div class="payment-proof-container">
                <img id="paymentProofImage" src="" alt="Payment Proof" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
            <div class="proof-actions" style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" id="approveProofBtn">Approve Payment</button>
                <button class="btn btn-danger" id="rejectProofBtn">Reject Payment</button>
            </div>
        </div>
    </div>

    <script>
        // Admin Panel JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Update active tab button
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + '-tab').classList.add('active');
                });
            });

            // Product management
            const productModal = document.getElementById('productModal');
            const productForm = document.getElementById('productForm');
            const paymentProofModal = document.getElementById('paymentProofModal');

            // Add product button
            document.getElementById('addProductBtn').addEventListener('click', function() {
                document.getElementById('modalTitle').textContent = 'Add New Product';
                productForm.reset();
                document.getElementById('productId').value = '';
                productModal.style.display = 'block';
            });

            // Edit product buttons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    // In a real app, fetch product data from API
                    document.getElementById('modalTitle').textContent = 'Edit Product';
                    document.getElementById('productId').value = productId;
                    productModal.style.display = 'block';
                });
            });

            // Delete product buttons
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this product?')) {
                        const productId = this.dataset.id;
                        fetch(`/api/delete_product/${productId}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            }
                        });
                    }
                });
            });

            // View payment proof buttons
            document.querySelectorAll('.view-payment-proof').forEach(btn => {
                btn.addEventListener('click', function() {
                    const proofUrl = this.dataset.proof;
                    const orderId = this.dataset.order;
                    
                    document.getElementById('paymentProofImage').src = proofUrl;
                    document.getElementById('proofOrderId').textContent = orderId;
                    
                    // Store order ID for approve/reject actions
                    document.getElementById('approveProofBtn').dataset.orderId = orderId;
                    document.getElementById('rejectProofBtn').dataset.orderId = orderId;
                    
                    paymentProofModal.style.display = 'block';
                });
            });

            // Approve payment proof
            document.getElementById('approveProofBtn').addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                updateOrderStatus(orderId, 'confirmed');
                paymentProofModal.style.display = 'none';
            });

            // Reject payment proof
            document.getElementById('rejectProofBtn').addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                updateOrderStatus(orderId, 'declined');
                paymentProofModal.style.display = 'none';
            });

            // Order management
            document.querySelectorAll('.confirm-order').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateOrderStatus(this.dataset.id, 'confirmed');
                });
            });

            document.querySelectorAll('.decline-order').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateOrderStatus(this.dataset.id, 'declined');
                });
            });

            // View order details
            document.querySelectorAll('.view-order').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    // Fetch and display order details
                    fetchOrderDetails(orderId);
                });
            });

            function updateOrderStatus(orderId, status) {
                fetch('/api/update_order_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to update order status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating order status');
                });
            }

            function fetchOrderDetails(orderId) {
                // For now, just show a simple message
                // In a real app, you'd fetch detailed order information
                document.getElementById('orderDetails').innerHTML = `
                    <p><strong>Order ID:</strong> #${orderId}</p>
                    <p>Detailed order information would be displayed here.</p>
                    <p>This would include:</p>
                    <ul>
                        <li>Customer information</li>
                        <li>Ordered items with quantities</li>
                        <li>Payment details</li>
                        <li>Order timeline</li>
                    </ul>
                `;
                document.getElementById('orderModal').style.display = 'block';
            }

            // Modal handling
            document.querySelectorAll('.close').forEach(element => {
                element.addEventListener('click', function() {
                    productModal.style.display = 'none';
                    document.getElementById('orderModal').style.display = 'none';
                    paymentProofModal.style.display = 'none';
                });
            });

            document.getElementById('cancelModal').addEventListener('click', function() {
                productModal.style.display = 'none';
            });

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === productModal) {
                    productModal.style.display = 'none';
                }
                if (event.target === document.getElementById('orderModal')) {
                    document.getElementById('orderModal').style.display = 'none';
                }
                if (event.target === paymentProofModal) {
                    paymentProofModal.style.display = 'none';
                }
            });

            // Product form submission
            productForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('productName').value,
                    price: document.getElementById('productPrice').value,
                    category: document.getElementById('productCategory').value,
                    description: document.getElementById('productDescription').value,
                    image_url: document.getElementById('productImage').value
                };

                const productId = document.getElementById('productId').value;
                const url = productId ? `/api/update_product/${productId}` : '/api/add_product';
                const method = productId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        productModal.style.display = 'none';
                        location.reload();
                    } else {
                        alert('Failed to save product');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving the product');
                });
            });
        });
    </script>
</body>
</html>